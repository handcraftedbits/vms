input {
  tcp {
    port => 5000
    ssl_verify => false
  }
}

filter {
  grok {
    patterns_dir => [
      "/opt/container/logstash"
    ]

    match => { "message" => "%{NGINX_HOST_ACCESS}" }
    
    add_field => {
      "containerAddress" => "%{host}"
      "eventType" => "httpAccess"
    }
    
    remove_field => [
      "host",
      "port"
    ]
  }

  if "" in [httpAccess] {
    geoip {
      source => "clientIP"
      target => "geoip"
    }
  }
}

output {
  stdout {
    codec => 'rubydebug'
  }

  elasticsearch {
    hosts => [
      "elasticsearch:9200"
    ]
  }
}
