{
  "builders": [
    {
      "type": "digitalocean",
      "api_token": "{{user `digitalocean-apitoken`}}",
      "image": "{{user `vm-digitalocean-image-name`}}",
      "region": "{{user `digitalocean-region`}}",
      "size": "{{user `vm-mem`}}",
      "droplet_name": "{{user `vm-hostname`}}",
      "snapshot_name": "{{user `vm-hostname`}}-{{user `vm-digitalocean-image-name`}}-{{timestamp}}",
      "ssh_username": "root"
    },

    {
      "type": "vmware-iso",
      "version": "11",
      "headless": "true",
      "http_directory": "http",
      "keep_registered": "true",
      "vnc_disable_password": "true",
      
      "remote_type": "esx5",
      "remote_host": "{{user `esxi-hostname`}}",
      "remote_username": "{{user `esxi-username`}}",
      "remote_password": "{{user `esxi-password`}}",
      "remote_datastore": "{{user `esxi-datastore-name`}}",
      "remote_cache_datastore": "{{user `esxi-datastore-cache-name`}}",
      "remote_cache_directory": "{{user `esxi-datastore-cache-directory`}}",

      "vm_name": "{{user `vm-hostname`}}",
      "output_directory": "{{user `vm-hostname`}}",
      "guest_os_type": "ubuntu-64",
      "vmdk_name": "{{user `vm-hostname`}}",
      "disk_size": "{{user `vm-esxi-disk-size`}}",
      "iso_url": "{{user `vm-esxi-iso-url`}}",
      "iso_checksum": "{{user `vm-esxi-iso-checksum`}}",
      "iso_checksum_type": "md5",
      "ssh_username": "{{user `vm-username`}}",
      "ssh_password": "{{user `vm-password`}}",
      "shutdown_command": "echo {{user `vm-password`}} | sudo -S shutdown -P now",
      "vmx_data": {
        "ethernet0.address": "{{user `vm-mac-address`}}",
        "ethernet0.addressType": "static",
        "ethernet0.networkName": "{{user `vm-esxi-network`}}",
        "ethernet0.virtualDev": "vmxnet3",
        "memSize": "{{user `vm-mem`}}",
        "numvcpus": "{{user `vm-esxi-cpus`}}",
        "scsi0.virtualDev": "pvscsi"
      },

      "boot_command": [
        "<esc><f6><esc>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs>",
        "preseed/url=http://{{.HTTPIP}}:{{.HTTPPort}}/preseed.cfg ",
        "debian-installer=en_US auto locale=en_US ",
        "kbd-chooser/method=us keyboard-configuration/layout=USA keyboard-configuration/variant=USA ",
        "hostname={{user `vm-hostname`}} ",
        "fb=false debconf/frontend=noninteractive ",
        "console-setup/ask_detect=false ",
        "passwd/user-fullname={{user `vm-user-fullname`}} ",
        "passwd/username={{user `vm-username`}} ",
        "passwd/user-password={{user `vm-password`}} ",
        "passwd/user-password-again={{user `vm-password`}} ",
        "initrd=/install/initrd.gz<enter>"
      ]
    }
  ],
  
  "provisioners": [
    {
      "type": "file",
      "source": "{{user `vm-data-dir`}}/provision_data",
      "destination": "/tmp/{{user `vm-hostname`}}"
    },

    {
      "type": "file",
      "source": "{{user `json_vars`}}",
      "destination": "/tmp/{{user `vm-hostname`}}/params.json"
    },

    {
      "type": "shell",
      "inline": [
        "echo {{user `vm-password`}} | sudo -S sh -c 'add-apt-repository ppa:ansible/ansible && apt-get update && apt-get install -y ansible python-jmespath'"
      ]
    },

    {
      "type": "ansible-local",
      "galaxy_file": "{{user `ansible-requirements`}}",
      "playbook_file": "{{user `ansible-playbook`}}",
      "extra_arguments": [
        "-e",
        "ansible_become_pass='{{user `vm-password`}}'",
        "--extra-vars",
        "'@/tmp/{{user `vm-hostname`}}/params.json'"
      ]
    },

    {
      "type": "shell",
      "inline": [
        "echo {{user `vm-password`}} | sudo -S sh -c 'rm -rf /tmp/*'"
      ]
    }
  ]
}
